<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link rel="icon" id="favicon" href="l1.png" media="(prefers-color-scheme: light)">
    <link rel="icon" id="favicon" href="d1.png" media="(prefers-color-scheme: dark)">
    <title>New Tab</title>
    <style>
 body {
     display: flex;
     height: 100vdh;
     justify-content: center;
     align-items: center;
     font-family: "Quicksand", sans-serif;
     overflow: hidden;
     padding-top: env(safe-area-inset-top);
     padding-left: env(safe-area-inset-left);
     padding-right: env(safe-area-inset-right);
     padding-bottom: env(safe-area-inset-bottom);
    }
 .contents {
     text-align: center;
     font-family: "Quicksand", sans-serif;
}
.nothing {
    border: none;
    background-color: transparent;
    font-family: "Quicksand", sans-serif;
    font-size: 1.2em;
    width: 90vw;
    text-align: center;
    color: inherit;
    caret-color: transparent;
}

 input:focus, select:focus, textarea:focus, button:focus {
     outline: none;
}

    </style>
  </head>
  <body> 
   <div class="contents">
<div style="font-size: 150%; left: 25px;" id="textshower"></div><br>
<div style="font-size: 150%; color: gray; left: 25px;" id="outputshower"></div>
<input type="text" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off" onkeypress="updatetext()" onkeyup="updatetext()" onkeydown="updatetext()" class="nothing" id="writtenstuff"></input>
    </div>
    <script>
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
let displayingtext = false;
let engine = 1;
if (localStorage.default) {
    engine = parseInt(localStorage.default);
}

const written = document.getElementById("writtenstuff");
const textshow = document.getElementById("outputshower");

if (localStorage.keywords == undefined) {
    const keywords = [];
    localStorage.setItem("keywords", JSON.stringify(keywords));
}
if (localStorage.engines == undefined) {
    const google = ["google", "https://www.google.com/search?q=%s"];
    const ecosia = ["ecosia", "https://www.ecosia.org/search?method=index&q=%s"];
    const engines = [JSON.stringify(google), JSON.stringify(ecosia)];
    localStorage.setItem("engines", JSON.stringify(engines));
}

const engines = JSON.parse(localStorage.engines);
const keywords = JSON.parse(localStorage.keywords);

document.body.addEventListener("touchend", () => {
  written.focus();
});

document.body.addEventListener("click", () => {
  written.focus();
});

window.onload = () => {
  setTimeout(() => written.focus(), 100); // delay helps on mobile
};

document.addEventListener("visibilitychange", function() {
    written.value = "";
    document.getElementById("textshower").innerText = "";
    textshow.innerHTML = "";
});

if (localStorage.colors === undefined || !localStorage.getItem("colors-set")) {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    const darkColors = ["#1c1b21", "#ffffff", "#8e8e8e"];
    const lightColors = ["#eaeaed", "#000000", "#8e8e8e"];

    const colors = prefersDark ? darkColors : lightColors;

    localStorage.setItem("colors", JSON.stringify(colors));
}

const colors = JSON.parse(localStorage.colors);

function applyColors(colors) {
    written.style.color = colors[0];
    document.body.style.backgroundColor = colors[0];
    document.getElementById("textshower").style.color = colors[1];
    document.getElementById("outputshower").style.color = colors[2];
}

applyColors(colors);
written.focus();

if (!localStorage.getItem("colors-set")) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const newColors = e.matches
            ? ["#1c1b21", "#ffffff", "#8e8e8e"]
            : ["#eaeaed", "#000000", "#8e8e8e"];

        localStorage.setItem("colors", JSON.stringify(newColors));
        applyColors(newColors);
    });
}

async function search() {
    if (written.value.substring(0, 7) == "ignore ") { //ignore 
        const enginedatas = JSON.parse(engines[engine]);
        window.location.href = enginedatas[1].replace("%s", written.value.substring(7, written.value.length));
        return;
    }
    if (written.value.substring(0, 8) == "default ") { // default
        for (let i = 0; i < engines.length; i++) {
            const enginedata = JSON.parse(engines[i]);
            if (written.value.substring(8, written.value.length) == enginedata[0]) {
                localStorage.setItem("default", i);
                written.value = "";
                document.getElementById("textshower").innerText = "";
                return;
            }
        }
    }
    for (let i = 0; i < keywords.length; i++) { // keyword
        const keyworddata = JSON.parse(keywords[i]);
        if (written.value == keyworddata[0]) {
            window.location.href = keyworddata[1];
            return;
        }
    }
    for (let i = 0; i < engines.length; i++) { // change engine
        const enginedata = JSON.parse(engines[i]);
        if (written.value == enginedata[0]) {
            engine = i;
            written.value = "";
            return;
        }
    }
    for (let i = 0; i < engines.length; i++) { // engine query
        const enginedata = JSON.parse(engines[i]);
        const writtennow = written.value.split(" ");
        let query = "";
        if (written.value.split(" ")[0] == enginedata[0] && written.value.split(" ").length > 1) {
            engine = i;
            for (let i = 1; i < writtennow.length; i++) {
                query += writtennow[i] + " ";
            }
            window.location.href = enginedata[1].replace("%s", query);
            return;
        }
    }
    if (written.value.substring(0, 12) == "add keyword ") { // add keyword
        written.selectionStart
        keywords.push(JSON.stringify(written.value.substring(12, written.value.length).split(" ")));
        localStorage.setItem("keywords", JSON.stringify(keywords));
        written.value = "";
        return;
    }
    if (written.value.substring(0, 15) == "remove keyword ") { // remove keyword
        for (let i = 0; i < keywords.length; i++) {
            const keyworddata = JSON.parse(keywords[i]);
            if (keyworddata.includes(written.value.substring(15, written.value.length))) {
                keywords.splice(i, 1);
                written.value = "";
                localStorage.setItem("keywords", JSON.stringify(keywords));
                return;
            }
        }
    }
    if (written.value.substring(0, 14) == "remove engine ") { // remove engine
        for (let i = 0; i < engines.length; i++) {
            const enginedata = JSON.parse(engines[i]);
            if (enginedata.includes(written.value.substring(14, written.value.length))) {
                engines.splice(i, 1);
                written.value = "";
                localStorage.setItem("engines", JSON.stringify(engines));
                return;
            }
        }
    }
    if (written.value.substring(0, 11) == "add engine ") { // add engine
        engines.push(JSON.stringify(written.value.substring(11, written.value.length).split(" ")));
        localStorage.setItem("engines", JSON.stringify(engines));
        written.value = "";
        return;
    }
    if (written.value.substring(0, 4) == "web ") { // web
        window.location.href = "https://" + written.value.substring(4, written.value.length);
        written.value = "";
        return;
    }

    const enginedata = JSON.parse(engines[engine]);
    window.location.href = enginedata[1].replace("%s", written.value);
}
document.addEventListener("keydown", function(event) {
    document.getElementById("writtenstuff").focus();
    if (event.key === "Enter" && displayingtext == false) {
        event.preventDefault();
        search();
    }
    if (displayingtext == true) {
        displayingtext = false;
        written.value = "";
        return;
    }
});
async function updatetext() {
    document.getElementById("textshower").innerText = written.value.slice(0, written.selectionStart) + "|" + written.value.slice(written.selectionStart);
    document.getElementById("outputshower").innerText = "";

    if (written.value == "engines") {
        for (let i = 0; i < engines.length; i++) {
            const enginedata2 = JSON.parse(engines[i]);
            if (i == engines.length - 1) {
                textshow.innerText += " " + enginedata2[0];
            } else {
                textshow.innerText += " " + enginedata2[0] + ",";
            }
        }
        return;
    }
    if (written.value == "keywords") {
        for (let i = 0; i < keywords.length; i++) {
            keyworddata = JSON.parse(keywords[i]);
            if (i == keywords.length - 1) {
                textshow.innerText += " " + keyworddata[0];
            } else {
                textshow.innerText += " " + keyworddata[0] + ",";
            }
        }
        return;
    }
    if (written.value == "help" || written.value == "help ") {
        textshow.innerText = "specify a category that is keywords, engines or other";
    }
    if (written.value.substring(0, 5) == "help ") {
        if (written.value.substring(5, written.value.length) == "keywords") {
            textshow.innerHTML = "add keyword [keyword] [link] - add a keyword<br>remove keyword [keyword] - remove a keyword<br>keywords - see all available keywords<br>[keyword] - use a keyword";
            return;
        }
        if (written.value.substring(5, written.value.length) == "engines") {
            textshow.innerHTML = "add engine [search engine] [link with %s in place of the query] - add a search engine<br>remove engine [search engine] - remove a search engine<br>default [engine] - set your default search engine<br>[engine] [query] - search with a search engine<br>[engine] - switch your current search engine<br>engines - see all available search engines";
            return;
        }
        if (written.value.substring(5, written.value.length) == "other") {
            textshow.innerHTML = "web [website domain] - go to a website<br>ignore [query] - search the query and ignore all commands";
            return;
        } else {
            if (written.value != "help ") {
            textshow.innerText = "category doesn't exist"
            }
        }
        return;
    }
}

async function insertcursor() {
    nextframe();
    const cursorposition = written.selectionStart;
    document.getElementById("textshower").innerText = written.value.slice(0, cursorposition) + "|" + written.value.slice(cursorposition);
    await sleep(500);
    nextframe();
    document.getElementById("textshower").innerText = written.value;
    setTimeout(insertcursor, 500);
}

const favicon = document.getElementById("favicon");

function nextframe() {
  if (window.matchMedia) {
    if(window.matchMedia('(prefers-color-scheme: dark)').matches){
      if (favicon.href.endsWith("favicon/d1.png")) {
           favicon.href = "favicon/d2.png";
      } else {
         favicon.href = "favicon/d1.png";
      }
    } else {
      if (favicon.href.endsWith("favicon/l1.png")) {
           favicon.href = "favicon/l2.png";
      } else {
          favicon.href = "favicon/l1.png";
      }
    }
  }
}
      
insertcursor();
      
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const query = urlParams.get("q");
if (query != null) {
    written.value = urlParams.get("q");
    search();
}

async function testcommands() {
    written.value = "help";
    updatetext();
    await sleep(500);
    written.value = "help keywords";
    updatetext();
    await sleep(500);
    written.value = "help engines";
    updatetext();
    await sleep(500);
    written.value = "help other";
    updatetext();
    await sleep(500);
    written.value = "engines";
    updatetext();
    await sleep(500);
    written.value = "keywords";
    updatetext();
    await sleep(500);
    written.value = "add keyword test";
    updatetext();
    search();
    if (JSON.stringify(keywords).includes("test") == false) {
        document.getElementById("outputshower").innerText = "Failed";
        return;
    } else {
        document.getElementById("outputshower").innerText = "Success";
    }
    await sleep(500);
    written.value = "remove keyword test";
    updatetext();
    search();
    if (JSON.stringify(keywords).includes("test")) {
        document.getElementById("outputshower").innerText = "Failed";
        return;
    } else {
        document.getElementById("outputshower").innerText = "Success";
    }
    await sleep(500);
    written.value = "add engine test";
    updatetext();
    search();
    if (JSON.stringify(engines).includes("test") == false) {
        document.getElementById("outputshower").innerText = "Failed";
        return;
    } else {
        document.getElementById("outputshower").innerText = "Success";
    }
    await sleep(500);
    written.value = "remove engine test";
    updatetext();
    search();
    if (JSON.stringify(engines).includes("test")) {
        document.getElementById("outputshower").innerText = "Failed";
        return;
    } else {
        document.getElementById("outputshower").innerText = "Success";
    }
    await sleep(1000);
    document.getElementById("outputshower").innerText = "";
}
    </script>
  </body>
</html>












